openapi: 3.0.3
info:
  title: Admin CRUD API
  version: 0.1.0
  description: |
    CRUD endpoints for managing activities data.

    ## Validation Rules

    All endpoints enforce the following validation rules to ensure data integrity
    and protect against security vulnerabilities.

    ### String Length Limits
    | Field | Max Length |
    |-------|-----------|
    | name | 200 characters |
    | description | 5,000 characters |
    | email | 320 characters |
    | phone_country_code | 2 characters |
    | phone_number | 20 characters |
    | social handles / URLs | 64 (handles) / 2,048 (URLs) |
    | address | 500 characters |
    | media_urls (each) | 2,048 characters |

    ### Array Limits
    | Field | Max Items |
    |-------|----------|
    | media_urls | 20 |
    | languages | 20 |

    ### Numeric Ranges
    | Field | Range |
    |-------|-------|
    | lat | -90 to 90 |
    | lng | -180 to 180 |
    | age_min | 0 to 119 |
    | age_max | 1 to 120 |
    | amount | >= 0 |
    | sessions_count | > 0 |
    | day_of_week_utc | 0-6 (Sunday-Saturday) |
    | day_of_month | 1-31 |
    | start_minutes_utc | 0-1439 |
    | end_minutes_utc | 0-1439 |

    ### Allowed Values
    | Field | Allowed Values |
    |-------|---------------|
    | currency | HKD, USD, EUR, GBP, CNY, JPY, SGD, AUD, CAD, CHF, NZD, TWD, KRW, THB, MYR, PHP, IDR, INR, VND |
    | languages | en, zh, ja, ko, fr, de, es, pt, it, ru, ar, hi, th, vi, id, ms, tl, nl, pl, tr, yue |
    | pricing_type | per_class, per_month, per_sessions |
    | schedule_type | weekly, monthly, date_specific |

    ### Contact Validation
    - phone_country_code must be an ISO 3166-1 alpha-2 country code.
    - phone_number must be valid for the selected phone_country_code.
    - email must be a valid email address.
    - social fields accept either an http/https URL or a handle.

paths:
  /v1/admin/organizations:
    get:
      summary: List organizations
      description: Retrieve a paginated list of organizations.
      parameters:
        - name: limit
          in: query
          required: false
          description: Maximum number of items to return (1-200, default 50)
          schema:
            type: integer
            minimum: 1
            maximum: 200
            default: 50
        - name: cursor
          in: query
          required: false
          description: Pagination cursor from previous response
          schema:
            type: string
      responses:
        "200":
          description: List of organizations
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/OrganizationListResponse'
    post:
      summary: Create organization
      description: Create a new organization.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/OrganizationCreate'
      responses:
        "201":
          description: Organization created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Organization'
        "400":
          description: Validation error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ValidationError'

  /v1/admin/organizations/{id}:
    parameters:
      - name: id
        in: path
        required: true
        schema:
          type: string
          format: uuid
    get:
      summary: Get organization
      responses:
        "200":
          description: Organization details
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Organization'
        "404":
          description: Organization not found
    put:
      summary: Update organization
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/OrganizationUpdate'
      responses:
        "200":
          description: Organization updated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Organization'
        "400":
          description: Validation error
        "404":
          description: Organization not found
    delete:
      summary: Delete organization
      responses:
        "204":
          description: Organization deleted
        "404":
          description: Organization not found

  /v1/admin/organizations/{id}/media:
    parameters:
      - name: id
        in: path
        required: true
        schema:
          type: string
          format: uuid
    post:
      summary: Create organization media upload URL
      description: Generate a presigned URL for uploading organization media.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/MediaUploadRequest'
      responses:
        "200":
          description: Upload URL generated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/MediaUploadResponse'
        "400":
          description: Validation error
    delete:
      summary: Delete organization media
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/MediaDeleteRequest'
      responses:
        "204":
          description: Media deleted

  /v1/admin/locations:
    get:
      summary: List locations
      parameters:
        - name: limit
          in: query
          required: false
          schema:
            type: integer
            minimum: 1
            maximum: 200
            default: 50
        - name: cursor
          in: query
          required: false
          schema:
            type: string
      responses:
        "200":
          description: List of locations
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/LocationListResponse'
    post:
      summary: Create location
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/LocationCreate'
      responses:
        "201":
          description: Location created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Location'
        "400":
          description: Validation error

  /v1/admin/locations/{id}:
    parameters:
      - name: id
        in: path
        required: true
        schema:
          type: string
          format: uuid
    get:
      summary: Get location
      responses:
        "200":
          description: Location details
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Location'
        "404":
          description: Location not found
    put:
      summary: Update location
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/LocationUpdate'
      responses:
        "200":
          description: Location updated
        "400":
          description: Validation error
        "404":
          description: Location not found
    delete:
      summary: Delete location
      responses:
        "204":
          description: Location deleted
        "404":
          description: Location not found

  /v1/admin/activities:
    get:
      summary: List activities
      parameters:
        - name: limit
          in: query
          required: false
          schema:
            type: integer
            minimum: 1
            maximum: 200
            default: 50
        - name: cursor
          in: query
          required: false
          schema:
            type: string
      responses:
        "200":
          description: List of activities
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ActivityListResponse'
    post:
      summary: Create activity
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ActivityCreate'
      responses:
        "201":
          description: Activity created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Activity'
        "400":
          description: Validation error

  /v1/admin/activities/{id}:
    parameters:
      - name: id
        in: path
        required: true
        schema:
          type: string
          format: uuid
    get:
      summary: Get activity
      responses:
        "200":
          description: Activity details
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Activity'
        "404":
          description: Activity not found
    put:
      summary: Update activity
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ActivityUpdate'
      responses:
        "200":
          description: Activity updated
        "400":
          description: Validation error
        "404":
          description: Activity not found
    delete:
      summary: Delete activity
      responses:
        "204":
          description: Activity deleted
        "404":
          description: Activity not found

  /v1/admin/pricing:
    get:
      summary: List pricing entries
      parameters:
        - name: limit
          in: query
          required: false
          schema:
            type: integer
            minimum: 1
            maximum: 200
            default: 50
        - name: cursor
          in: query
          required: false
          schema:
            type: string
      responses:
        "200":
          description: List of pricing entries
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PricingListResponse'
    post:
      summary: Create pricing entry
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/PricingCreate'
      responses:
        "201":
          description: Pricing entry created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Pricing'
        "400":
          description: Validation error

  /v1/admin/pricing/{id}:
    parameters:
      - name: id
        in: path
        required: true
        schema:
          type: string
          format: uuid
    get:
      summary: Get pricing entry
      responses:
        "200":
          description: Pricing details
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Pricing'
        "404":
          description: Pricing not found
    put:
      summary: Update pricing entry
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/PricingUpdate'
      responses:
        "200":
          description: Pricing updated
        "400":
          description: Validation error
        "404":
          description: Pricing not found
    delete:
      summary: Delete pricing entry
      responses:
        "204":
          description: Pricing deleted
        "404":
          description: Pricing not found

  /v1/admin/schedules:
    get:
      summary: List schedules
      parameters:
        - name: limit
          in: query
          required: false
          schema:
            type: integer
            minimum: 1
            maximum: 200
            default: 50
        - name: cursor
          in: query
          required: false
          schema:
            type: string
      responses:
        "200":
          description: List of schedules
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ScheduleListResponse'
    post:
      summary: Create schedule
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ScheduleCreate'
      responses:
        "201":
          description: Schedule created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Schedule'
        "400":
          description: Validation error

  /v1/admin/schedules/{id}:
    parameters:
      - name: id
        in: path
        required: true
        schema:
          type: string
          format: uuid
    get:
      summary: Get schedule
      responses:
        "200":
          description: Schedule details
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Schedule'
        "404":
          description: Schedule not found
    put:
      summary: Update schedule
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ScheduleUpdate'
      responses:
        "200":
          description: Schedule updated
        "400":
          description: Validation error
        "404":
          description: Schedule not found
    delete:
      summary: Delete schedule
      responses:
        "204":
          description: Schedule deleted
        "404":
          description: Schedule not found

  /v1/admin/users/{username}/groups:
    parameters:
      - name: username
        in: path
        required: true
        schema:
          type: string
    post:
      summary: Add user to group
      requestBody:
        content:
          application/json:
            schema:
              type: object
              properties:
                group:
                  type: string
                  description: Group name (defaults to 'admin')
      responses:
        "200":
          description: User added to group
    delete:
      summary: Remove user from group
      responses:
        "200":
          description: User removed from group

  # --- Cognito Users Management (Admin Only) ---

  /v1/admin/cognito-users:
    get:
      summary: List Cognito users
      description: |
        List all Cognito user pool users with their group memberships.
        Used for manager selection and user management.
      parameters:
        - name: limit
          in: query
          required: false
          description: Maximum number of users to return (1-60, default 50)
          schema:
            type: integer
            minimum: 1
            maximum: 60
            default: 50
        - name: pagination_token
          in: query
          required: false
          description: Pagination token from previous response
          schema:
            type: string
      responses:
        "200":
          description: List of Cognito users
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CognitoUserListResponse'

  /v1/admin/cognito-users/{username}:
    parameters:
      - name: username
        in: path
        required: true
        schema:
          type: string
    delete:
      summary: Delete Cognito user
      description: |
        Delete a Cognito user and transfer their managed organizations
        to the requesting admin user. The admin cannot delete themselves.
      responses:
        "200":
          description: User deleted and organizations transferred
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    description: Deletion status (e.g., "deleted")
                  username:
                    type: string
                    description: Username of the deleted user
                  user_sub:
                    type: string
                    description: Cognito sub of the deleted user
                  transferred_organizations_count:
                    type: integer
                    description: Number of organizations transferred to the admin
                  fallback_manager_id:
                    type: string
                    description: Cognito sub of the admin who received the transferred organizations
        "400":
          description: Cannot delete yourself
        "404":
          description: Cognito user not found

  # --- Tickets Management (Admin Only) ---

  /v1/admin/tickets:
    get:
      summary: List tickets
      description: |
        List all tickets for admin review. Supports filtering by
        ticket_type, status, and cursor pagination.
      parameters:
        - name: ticket_type
          in: query
          required: false
          description: Filter by ticket type
          schema:
            type: string
            enum: [access_request, organization_suggestion]
        - name: status
          in: query
          required: false
          description: Filter by ticket status
          schema:
            type: string
            enum: [pending, approved, rejected]
        - name: limit
          in: query
          required: false
          schema:
            type: integer
            minimum: 1
            maximum: 200
            default: 50
        - name: cursor
          in: query
          required: false
          schema:
            type: string
      responses:
        "200":
          description: List of tickets
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TicketListResponse'

  /v1/admin/tickets/{id}:
    parameters:
      - name: id
        in: path
        required: true
        schema:
          type: string
          format: uuid
    put:
      summary: Review ticket
      description: |
        Approve or reject a ticket. Approval behaviour depends on the
        ticket_type. The request body may include organization_id,
        create_organization, and admin_notes.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/TicketReview'
      responses:
        "200":
          description: Ticket reviewed
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TicketReviewResponse'
        "400":
          description: Validation error
        "404":
          description: Ticket not found

  # --- Audit Logs (Admin Only, Read-Only) ---

  /v1/admin/audit-logs:
    get:
      summary: List audit logs
      description: |
        Query audit logs with optional filtering by table, record, user,
        action type, and timestamp. Returns paginated results.
      parameters:
        - name: table
          in: query
          required: false
          description: Filter by table name (required if record_id is provided)
          schema:
            type: string
        - name: record_id
          in: query
          required: false
          description: Filter by specific record ID (requires table parameter)
          schema:
            type: string
        - name: user_id
          in: query
          required: false
          description: Filter by user who made the change
          schema:
            type: string
        - name: action
          in: query
          required: false
          description: Filter by action type
          schema:
            type: string
            enum: [INSERT, UPDATE, DELETE]
        - name: since
          in: query
          required: false
          description: Filter by timestamp (ISO 8601 format)
          schema:
            type: string
            format: date-time
        - name: limit
          in: query
          required: false
          schema:
            type: integer
            minimum: 1
            maximum: 200
            default: 50
        - name: cursor
          in: query
          required: false
          schema:
            type: string
      responses:
        "200":
          description: List of audit log entries
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AuditLogListResponse'

  /v1/admin/audit-logs/{id}:
    parameters:
      - name: id
        in: path
        required: true
        schema:
          type: string
          format: uuid
    get:
      summary: Get audit log entry
      responses:
        "200":
          description: Audit log entry details
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AuditLogEntry'
        "404":
          description: Audit log entry not found

  # --- Manager Routes (Admin or Manager Group) ---

  /v1/manager/organizations:
    get:
      summary: List managed organizations
      description: |
        List organizations managed by the authenticated user.
        Results are filtered by the user's organization management.
      parameters:
        - name: limit
          in: query
          required: false
          schema:
            type: integer
            minimum: 1
            maximum: 200
            default: 50
        - name: cursor
          in: query
          required: false
          schema:
            type: string
      responses:
        "200":
          description: List of managed organizations
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/OrganizationListResponse'
    post:
      summary: Create organization (manager)
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/OrganizationCreate'
      responses:
        "201":
          description: Organization created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Organization'
        "400":
          description: Validation error

  /v1/manager/organizations/{id}:
    parameters:
      - name: id
        in: path
        required: true
        schema:
          type: string
          format: uuid
    get:
      summary: Get managed organization
      responses:
        "200":
          description: Organization details
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Organization'
        "403":
          description: Not a manager of this organization
        "404":
          description: Organization not found
    put:
      summary: Update managed organization
      description: Managers cannot change the manager_id field.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/OrganizationUpdate'
      responses:
        "200":
          description: Organization updated
        "400":
          description: Validation error
        "403":
          description: Not a manager of this organization
        "404":
          description: Organization not found
    delete:
      summary: Delete managed organization
      responses:
        "204":
          description: Organization deleted
        "403":
          description: Not a manager of this organization
        "404":
          description: Organization not found

  /v1/manager/locations:
    get:
      summary: List locations in managed organizations
      parameters:
        - name: limit
          in: query
          required: false
          schema:
            type: integer
            minimum: 1
            maximum: 200
            default: 50
        - name: cursor
          in: query
          required: false
          schema:
            type: string
      responses:
        "200":
          description: List of locations
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/LocationListResponse'
    post:
      summary: Create location in managed organization
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/LocationCreate'
      responses:
        "201":
          description: Location created
        "400":
          description: Validation error
        "403":
          description: Not a manager of the target organization

  /v1/manager/locations/{id}:
    parameters:
      - name: id
        in: path
        required: true
        schema:
          type: string
          format: uuid
    get:
      summary: Get location in managed organization
      responses:
        "200":
          description: Location details
        "403":
          description: Not a manager of this organization
        "404":
          description: Location not found
    put:
      summary: Update location in managed organization
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/LocationUpdate'
      responses:
        "200":
          description: Location updated
        "400":
          description: Validation error
        "403":
          description: Not a manager of this organization
        "404":
          description: Location not found
    delete:
      summary: Delete location in managed organization
      responses:
        "204":
          description: Location deleted
        "403":
          description: Not a manager of this organization
        "404":
          description: Location not found

  /v1/manager/activities:
    get:
      summary: List activities in managed organizations
      parameters:
        - name: limit
          in: query
          required: false
          schema:
            type: integer
            minimum: 1
            maximum: 200
            default: 50
        - name: cursor
          in: query
          required: false
          schema:
            type: string
      responses:
        "200":
          description: List of activities
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ActivityListResponse'
    post:
      summary: Create activity in managed organization
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ActivityCreate'
      responses:
        "201":
          description: Activity created
        "400":
          description: Validation error
        "403":
          description: Not a manager of the target organization

  /v1/manager/activities/{id}:
    parameters:
      - name: id
        in: path
        required: true
        schema:
          type: string
          format: uuid
    get:
      summary: Get activity in managed organization
      responses:
        "200":
          description: Activity details
        "403":
          description: Not a manager of this organization
        "404":
          description: Activity not found
    put:
      summary: Update activity in managed organization
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ActivityUpdate'
      responses:
        "200":
          description: Activity updated
        "400":
          description: Validation error
        "403":
          description: Not a manager of this organization
        "404":
          description: Activity not found
    delete:
      summary: Delete activity in managed organization
      responses:
        "204":
          description: Activity deleted
        "403":
          description: Not a manager of this organization
        "404":
          description: Activity not found

  /v1/manager/pricing:
    get:
      summary: List pricing in managed organizations
      parameters:
        - name: limit
          in: query
          required: false
          schema:
            type: integer
            minimum: 1
            maximum: 200
            default: 50
        - name: cursor
          in: query
          required: false
          schema:
            type: string
      responses:
        "200":
          description: List of pricing entries
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PricingListResponse'
    post:
      summary: Create pricing in managed organization
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/PricingCreate'
      responses:
        "201":
          description: Pricing created
        "400":
          description: Validation error
        "403":
          description: Not a manager of the target organization

  /v1/manager/pricing/{id}:
    parameters:
      - name: id
        in: path
        required: true
        schema:
          type: string
          format: uuid
    get:
      summary: Get pricing in managed organization
      responses:
        "200":
          description: Pricing details
        "403":
          description: Not a manager of this organization
        "404":
          description: Pricing not found
    put:
      summary: Update pricing in managed organization
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/PricingUpdate'
      responses:
        "200":
          description: Pricing updated
        "400":
          description: Validation error
        "403":
          description: Not a manager of this organization
        "404":
          description: Pricing not found
    delete:
      summary: Delete pricing in managed organization
      responses:
        "204":
          description: Pricing deleted
        "403":
          description: Not a manager of this organization
        "404":
          description: Pricing not found

  /v1/manager/schedules:
    get:
      summary: List schedules in managed organizations
      parameters:
        - name: limit
          in: query
          required: false
          schema:
            type: integer
            minimum: 1
            maximum: 200
            default: 50
        - name: cursor
          in: query
          required: false
          schema:
            type: string
      responses:
        "200":
          description: List of schedules
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ScheduleListResponse'
    post:
      summary: Create schedule in managed organization
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ScheduleCreate'
      responses:
        "201":
          description: Schedule created
        "400":
          description: Validation error
        "403":
          description: Not a manager of the target organization

  /v1/manager/schedules/{id}:
    parameters:
      - name: id
        in: path
        required: true
        schema:
          type: string
          format: uuid
    get:
      summary: Get schedule in managed organization
      responses:
        "200":
          description: Schedule details
        "403":
          description: Not a manager of this organization
        "404":
          description: Schedule not found
    put:
      summary: Update schedule in managed organization
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ScheduleUpdate'
      responses:
        "200":
          description: Schedule updated
        "400":
          description: Validation error
        "403":
          description: Not a manager of this organization
        "404":
          description: Schedule not found
    delete:
      summary: Delete schedule in managed organization
      responses:
        "204":
          description: Schedule deleted
        "403":
          description: Not a manager of this organization
        "404":
          description: Schedule not found

  # --- Geographic Areas Management (Admin Only) ---

  /v1/admin/areas:
    get:
      summary: List all geographic areas
      description: |
        Returns the full geographic area tree including inactive countries.
        Admin-only endpoint for managing area activation.
      responses:
        "200":
          description: Full area tree
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AreaTreeResponse'

  /v1/admin/areas/{id}:
    parameters:
      - name: id
        in: path
        required: true
        schema:
          type: string
          format: uuid
    patch:
      summary: Toggle area active status
      description: |
        Activate or deactivate a geographic area (typically a country).
        When a country is deactivated, it and its children are hidden
        from user-facing endpoints.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [active]
              properties:
                active:
                  type: boolean
                  description: New active state
      responses:
        "200":
          description: Area updated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/GeographicArea'
        "404":
          description: Area not found

  # --- User Routes (Any Authenticated User) ---

  /v1/user/areas:
    get:
      summary: List active geographic areas
      description: |
        Returns the geographic area tree for active countries only.
        Used by frontend for cascading country/district dropdowns.
      responses:
        "200":
          description: Active area tree
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AreaTreeResponse'

  /v1/user/access-request:
    get:
      summary: Check access request status
      description: |
        Check if the authenticated user has a pending manager access request
        and get their managed organizations count.
      responses:
        "200":
          description: User's access request status
          content:
            application/json:
              schema:
                type: object
                properties:
                  has_pending_request:
                    type: boolean
                  pending_request:
                    $ref: '#/components/schemas/Ticket'
                    nullable: true
                  organizations_count:
                    type: integer
                    description: Number of organizations the user manages
    post:
      summary: Submit access request
      description: |
        Submit a request to become a manager of an organization.
        Only one pending request per user is allowed.
        Request is published to SNS for async processing.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/AccessRequestCreate'
      responses:
        "202":
          description: Request submitted for processing
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                  ticket_id:
                    type: string
                    description: Unique ticket ID (e.g., R00001)
        "409":
          description: User already has a pending access request

  /v1/user/organization-suggestion:
    get:
      summary: Get suggestion history
      description: |
        Get the authenticated user's organization suggestion history
        and check if they have a pending suggestion.
      responses:
        "200":
          description: User's suggestion history
          content:
            application/json:
              schema:
                type: object
                properties:
                  has_pending_suggestion:
                    type: boolean
                  suggestions:
                    type: array
                    items:
                      $ref: '#/components/schemas/Ticket'
    post:
      summary: Submit organization suggestion
      description: |
        Suggest a new organization/place for the platform.
        Any authenticated user can submit suggestions.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/OrganizationSuggestionCreate'
      responses:
        "202":
          description: Suggestion submitted
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                  ticket_id:
                    type: string
                    description: Unique ticket ID (e.g., S00001)
        "409":
          description: User already has a pending suggestion

  # --- Health Check ---

  /health:
    get:
      summary: Health check
      description: |
        Service health check endpoint. Returns overall health status,
        including database connectivity and configuration checks.
        Requires IAM authentication.
      security:
        - IAMAuth: []
      parameters:
        - name: details
          in: query
          required: false
          description: Set to 'true' to include detailed check information
          schema:
            type: string
            enum: ["true", "false"]
      responses:
        "200":
          description: Service is healthy
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/HealthStatus'
        "503":
          description: Service is unhealthy
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/HealthStatus'

components:
  securitySchemes:
    AdminGroupAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: Cognito JWT token, user must be in 'admin' group
    ManagerGroupAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: Cognito JWT token, user must be in 'admin' or 'manager' group
    UserAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: Cognito JWT token, any authenticated user
    IAMAuth:
      type: apiKey
      in: header
      name: Authorization
      description: AWS IAM Signature V4
  schemas:
    ValidationError:
      type: object
      required: [error]
      properties:
        error:
          type: string
          description: Error message
        detail:
          type: string
          description: Additional details (e.g., field name)

    # Organization schemas
    OrganizationCreate:
      type: object
      required:
        - name
        - manager_id
      properties:
        name:
          type: string
          maxLength: 200
          description: Organization name (required, max 200 characters)
        description:
          type: string
          maxLength: 5000
          description: Organization description (optional, max 5,000 characters)
        manager_id:
          type: string
          description: Cognito user sub of the organization manager (required)
        phone_country_code:
          type: string
          maxLength: 2
          description: ISO 3166-1 alpha-2 country code for phone number
        phone_number:
          type: string
          maxLength: 20
          description: National phone number digits (no country code)
        email:
          type: string
          maxLength: 320
          description: Contact email address
        whatsapp:
          type: string
          maxLength: 2048
          description: WhatsApp handle or URL
        facebook:
          type: string
          maxLength: 2048
          description: Facebook handle or URL
        instagram:
          type: string
          maxLength: 2048
          description: Instagram handle or URL
        tiktok:
          type: string
          maxLength: 2048
          description: TikTok handle or URL
        twitter:
          type: string
          maxLength: 2048
          description: Twitter handle or URL
        little_red_book:
          type: string
          maxLength: 2048
          description: Little Red Book handle or URL
        wechat:
          type: string
          maxLength: 2048
          description: WeChat handle or URL
        media_urls:
          type: array
          maxItems: 20
          items:
            type: string
            format: uri
            maxLength: 2048
          description: |
            List of media URLs (optional, max 20 URLs).
            Each URL must use http or https scheme and be max 2,048 characters.

    OrganizationUpdate:
      type: object
      properties:
        name:
          type: string
          maxLength: 200
          description: Organization name (max 200 characters)
        description:
          type: string
          maxLength: 5000
          description: Organization description (max 5,000 characters)
        manager_id:
          type: string
          description: Cognito user sub of the organization manager
        phone_country_code:
          type: string
          maxLength: 2
          description: ISO 3166-1 alpha-2 country code for phone number
        phone_number:
          type: string
          maxLength: 20
          description: National phone number digits (no country code)
        email:
          type: string
          maxLength: 320
          description: Contact email address
        whatsapp:
          type: string
          maxLength: 2048
          description: WhatsApp handle or URL
        facebook:
          type: string
          maxLength: 2048
          description: Facebook handle or URL
        instagram:
          type: string
          maxLength: 2048
          description: Instagram handle or URL
        tiktok:
          type: string
          maxLength: 2048
          description: TikTok handle or URL
        twitter:
          type: string
          maxLength: 2048
          description: Twitter handle or URL
        little_red_book:
          type: string
          maxLength: 2048
          description: Little Red Book handle or URL
        wechat:
          type: string
          maxLength: 2048
          description: WeChat handle or URL
        media_urls:
          type: array
          maxItems: 20
          items:
            type: string
            format: uri
            maxLength: 2048

    Organization:
      type: object
      required: [id, name, manager_id, media_urls, created_at, updated_at]
      properties:
        id:
          type: string
          format: uuid
        name:
          type: string
        description:
          type: string
          nullable: true
        manager_id:
          type: string
          description: Cognito user sub of the organization manager
        phone_country_code:
          type: string
          nullable: true
          description: ISO 3166-1 alpha-2 country code for phone number
        phone_number:
          type: string
          nullable: true
          description: National phone number digits (no country code)
        email:
          type: string
          nullable: true
          description: Contact email address
        whatsapp:
          type: string
          nullable: true
          description: WhatsApp handle or URL
        facebook:
          type: string
          nullable: true
          description: Facebook handle or URL
        instagram:
          type: string
          nullable: true
          description: Instagram handle or URL
        tiktok:
          type: string
          nullable: true
          description: TikTok handle or URL
        twitter:
          type: string
          nullable: true
          description: Twitter handle or URL
        little_red_book:
          type: string
          nullable: true
          description: Little Red Book handle or URL
        wechat:
          type: string
          nullable: true
          description: WeChat handle or URL
        media_urls:
          type: array
          items:
            type: string
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time

    OrganizationListResponse:
      type: object
      required: [items]
      properties:
        items:
          type: array
          items:
            $ref: '#/components/schemas/Organization'
        next_cursor:
          type: string
          nullable: true

    # Location schemas
    LocationCreate:
      type: object
      required:
        - org_id
        - area_id
      properties:
        org_id:
          type: string
          format: uuid
          description: Organization UUID (required)
        area_id:
          type: string
          format: uuid
          description: Geographic area UUID (required, must be a leaf node)
        address:
          type: string
          maxLength: 500
          description: Full address (optional, max 500 characters)
        lat:
          type: number
          minimum: -90
          maximum: 90
          description: Latitude (-90 to 90)
        lng:
          type: number
          minimum: -180
          maximum: 180
          description: Longitude (-180 to 180)

    LocationUpdate:
      type: object
      properties:
        area_id:
          type: string
          format: uuid
          description: Geographic area UUID (must be a leaf node)
        address:
          type: string
          maxLength: 500
          description: Full address (max 500 characters)
        lat:
          type: number
          minimum: -90
          maximum: 90
          description: Latitude (-90 to 90)
        lng:
          type: number
          minimum: -180
          maximum: 180
          description: Longitude (-180 to 180)

    Location:
      type: object
      required: [id, org_id, area_id, created_at, updated_at]
      properties:
        id:
          type: string
          format: uuid
        org_id:
          type: string
          format: uuid
        area_id:
          type: string
          format: uuid
          description: Geographic area UUID (leaf node)
        address:
          type: string
          nullable: true
        lat:
          type: number
          nullable: true
        lng:
          type: number
          nullable: true
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time

    LocationListResponse:
      type: object
      required: [items]
      properties:
        items:
          type: array
          items:
            $ref: '#/components/schemas/Location'
        next_cursor:
          type: string
          nullable: true

    # Activity schemas
    ActivityCreate:
      type: object
      required:
        - org_id
        - name
        - age_min
        - age_max
      properties:
        org_id:
          type: string
          format: uuid
          description: Organization UUID (required)
        name:
          type: string
          maxLength: 200
          description: Activity name (required, max 200 characters)
        description:
          type: string
          maxLength: 5000
          description: Activity description (optional, max 5,000 characters)
        age_min:
          type: integer
          minimum: 0
          maximum: 119
          description: Minimum age (required, 0-119, must be less than age_max)
        age_max:
          type: integer
          minimum: 1
          maximum: 120
          description: Maximum age (required, 1-120, must be greater than age_min)

    ActivityUpdate:
      type: object
      properties:
        name:
          type: string
          maxLength: 200
          description: Activity name (max 200 characters)
        description:
          type: string
          maxLength: 5000
          description: Activity description (max 5,000 characters)
        age_min:
          type: integer
          minimum: 0
          maximum: 119
          description: Minimum age (must provide both age_min and age_max together)
        age_max:
          type: integer
          minimum: 1
          maximum: 120
          description: Maximum age (must provide both age_min and age_max together)

    Activity:
      type: object
      required: [id, org_id, name, age_min, age_max, created_at, updated_at]
      properties:
        id:
          type: string
          format: uuid
        org_id:
          type: string
          format: uuid
        name:
          type: string
        description:
          type: string
          nullable: true
        age_min:
          type: integer
        age_max:
          type: integer
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time

    ActivityListResponse:
      type: object
      required: [items]
      properties:
        items:
          type: array
          items:
            $ref: '#/components/schemas/Activity'
        next_cursor:
          type: string
          nullable: true

    # Pricing schemas
    PricingCreate:
      type: object
      required:
        - activity_id
        - location_id
        - pricing_type
        - amount
      properties:
        activity_id:
          type: string
          format: uuid
          description: Activity UUID (required)
        location_id:
          type: string
          format: uuid
          description: Location UUID (required)
        pricing_type:
          type: string
          enum: [per_class, per_month, per_sessions]
          description: |
            Pricing type (required):
            - per_class: Price per individual class
            - per_month: Monthly subscription price
            - per_sessions: Price for a package of sessions (requires sessions_count)
        amount:
          type: number
          minimum: 0
          description: Price amount (required, must be >= 0)
        currency:
          type: string
          enum: [HKD, USD, EUR, GBP, CNY, JPY, SGD, AUD, CAD, CHF, NZD, TWD, KRW, THB, MYR, PHP, IDR, INR, VND]
          default: HKD
          description: ISO 4217 currency code (default HKD)
        sessions_count:
          type: integer
          minimum: 1
          description: Number of sessions (required when pricing_type is per_sessions, must be > 0)

    PricingUpdate:
      type: object
      properties:
        pricing_type:
          type: string
          enum: [per_class, per_month, per_sessions]
        amount:
          type: number
          minimum: 0
          description: Price amount (must be >= 0)
        currency:
          type: string
          enum: [HKD, USD, EUR, GBP, CNY, JPY, SGD, AUD, CAD, CHF, NZD, TWD, KRW, THB, MYR, PHP, IDR, INR, VND]
        sessions_count:
          type: integer
          minimum: 1
          description: Number of sessions (must be > 0)

    Pricing:
      type: object
      required: [id, activity_id, location_id, pricing_type, amount, currency]
      properties:
        id:
          type: string
          format: uuid
        activity_id:
          type: string
          format: uuid
        location_id:
          type: string
          format: uuid
        pricing_type:
          type: string
        amount:
          type: number
        currency:
          type: string
        sessions_count:
          type: integer
          nullable: true

    PricingListResponse:
      type: object
      required: [items]
      properties:
        items:
          type: array
          items:
            $ref: '#/components/schemas/Pricing'
        next_cursor:
          type: string
          nullable: true

    # Schedule schemas
    ScheduleCreate:
      type: object
      required:
        - activity_id
        - location_id
        - schedule_type
      properties:
        activity_id:
          type: string
          format: uuid
          description: Activity UUID (required)
        location_id:
          type: string
          format: uuid
          description: Location UUID (required)
        schedule_type:
          type: string
          enum: [weekly, monthly, date_specific]
          description: |
            Schedule type (required):
            - weekly: Recurring weekly (requires day_of_week_utc, start_minutes_utc, end_minutes_utc)
            - monthly: Recurring monthly (requires day_of_month, start_minutes_utc, end_minutes_utc)
            - date_specific: One-time event (requires start_at_utc, end_at_utc)
        day_of_week_utc:
          type: integer
          minimum: 0
          maximum: 6
          description: |
            Day of week in UTC (required for weekly):
            0=Sunday, 1=Monday, 2=Tuesday, 3=Wednesday, 4=Thursday, 5=Friday, 6=Saturday
        day_of_month:
          type: integer
          minimum: 1
          maximum: 31
          description: Day of month (required for monthly, 1-31)
        start_minutes_utc:
          type: integer
          minimum: 0
          maximum: 1439
          description: |
            Start time in minutes from midnight UTC (required for weekly/monthly).
            Range: 0-1439 (0 = 00:00, 1439 = 23:59).
            Must be less than end_minutes_utc.
        end_minutes_utc:
          type: integer
          minimum: 0
          maximum: 1439
          description: |
            End time in minutes from midnight UTC (required for weekly/monthly).
            Range: 0-1439 (0 = 00:00, 1439 = 23:59).
            Must be greater than start_minutes_utc.
        start_at_utc:
          type: string
          format: date-time
          description: Start datetime in UTC (required for date_specific, must be before end_at_utc)
        end_at_utc:
          type: string
          format: date-time
          description: End datetime in UTC (required for date_specific, must be after start_at_utc)
        languages:
          type: array
          maxItems: 20
          items:
            type: string
            enum: [en, zh, ja, ko, fr, de, es, pt, it, ru, ar, hi, th, vi, id, ms, tl, nl, pl, tr, yue]
          description: |
            ISO 639-1 language codes (optional, max 20).
            Supported: en (English), zh (Chinese), ja (Japanese), ko (Korean),
            fr (French), de (German), es (Spanish), pt (Portuguese), it (Italian),
            ru (Russian), ar (Arabic), hi (Hindi), th (Thai), vi (Vietnamese),
            id (Indonesian), ms (Malay), tl (Tagalog), nl (Dutch), pl (Polish),
            tr (Turkish), yue (Cantonese)

    ScheduleUpdate:
      type: object
      properties:
        schedule_type:
          type: string
          enum: [weekly, monthly, date_specific]
        day_of_week_utc:
          type: integer
          minimum: 0
          maximum: 6
        day_of_month:
          type: integer
          minimum: 1
          maximum: 31
        start_minutes_utc:
          type: integer
          minimum: 0
          maximum: 1439
        end_minutes_utc:
          type: integer
          minimum: 0
          maximum: 1439
        start_at_utc:
          type: string
          format: date-time
        end_at_utc:
          type: string
          format: date-time
        languages:
          type: array
          maxItems: 20
          items:
            type: string
            enum: [en, zh, ja, ko, fr, de, es, pt, it, ru, ar, hi, th, vi, id, ms, tl, nl, pl, tr, yue]

    Schedule:
      type: object
      required: [id, activity_id, location_id, schedule_type, languages]
      properties:
        id:
          type: string
          format: uuid
        activity_id:
          type: string
          format: uuid
        location_id:
          type: string
          format: uuid
        schedule_type:
          type: string
        day_of_week_utc:
          type: integer
          nullable: true
        day_of_month:
          type: integer
          nullable: true
        start_minutes_utc:
          type: integer
          nullable: true
        end_minutes_utc:
          type: integer
          nullable: true
        start_at_utc:
          type: string
          format: date-time
          nullable: true
        end_at_utc:
          type: string
          format: date-time
          nullable: true
        languages:
          type: array
          items:
            type: string

    ScheduleListResponse:
      type: object
      required: [items]
      properties:
        items:
          type: array
          items:
            $ref: '#/components/schemas/Schedule'
        next_cursor:
          type: string
          nullable: true

    # Media upload schemas
    MediaUploadRequest:
      type: object
      required:
        - file_name
        - content_type
      properties:
        file_name:
          type: string
          description: Original file name
        content_type:
          type: string
          pattern: '^image/'
          description: MIME type (must start with 'image/')

    MediaUploadResponse:
      type: object
      required: [upload_url, media_url, object_key, expires_in]
      properties:
        upload_url:
          type: string
          description: Presigned S3 upload URL (expires in 15 minutes)
        media_url:
          type: string
          description: Final public URL of the media file
        object_key:
          type: string
          description: S3 object key
        expires_in:
          type: integer
          description: URL expiration time in seconds

    MediaDeleteRequest:
      type: object
      properties:
        object_key:
          type: string
          description: S3 object key to delete
        media_url:
          type: string
          description: Media URL to delete (alternative to object_key)

    # Cognito User schemas
    CognitoUser:
      type: object
      required: [sub, email, email_verified, username, status, enabled, groups, created_at, updated_at]
      properties:
        sub:
          type: string
          description: Cognito user sub (UUID)
        email:
          type: string
        email_verified:
          type: boolean
        name:
          type: string
          nullable: true
        given_name:
          type: string
          nullable: true
        family_name:
          type: string
          nullable: true
        username:
          type: string
        status:
          type: string
          description: Cognito user status (e.g., CONFIRMED, FORCE_CHANGE_PASSWORD)
        enabled:
          type: boolean
        groups:
          type: array
          items:
            type: string
          description: Cognito group memberships
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time
        last_auth_time:
          type: string
          format: date-time
          nullable: true

    CognitoUserListResponse:
      type: object
      required: [items]
      properties:
        items:
          type: array
          items:
            $ref: '#/components/schemas/CognitoUser'
        pagination_token:
          type: string
          nullable: true
          description: Token for fetching the next page

    # Access Request input schema (used by user-facing POST endpoint)
    AccessRequestCreate:
      type: object
      required:
        - organization_name
      properties:
        organization_name:
          type: string
          maxLength: 200
          description: Name of the organization to request access to
        request_message:
          type: string
          maxLength: 5000
          description: Optional message to the admin

    # Ticket schemas
    Ticket:
      type: object
      required: [id, ticket_id, ticket_type, organization_name, media_urls, status, submitter_id, submitter_email, created_at]
      properties:
        id:
          type: string
          format: uuid
        ticket_id:
          type: string
          description: Unique progressive ticket ID (prefix + 5 digits)
        ticket_type:
          type: string
          enum: [access_request, organization_suggestion]
        organization_name:
          type: string
        message:
          type: string
          nullable: true
          description: Free-text message from the submitter
        status:
          type: string
          enum: [pending, approved, rejected]
        submitter_id:
          type: string
          description: Cognito user sub of the submitter
        submitter_email:
          type: string
        created_at:
          type: string
          format: date-time
        reviewed_at:
          type: string
          format: date-time
          nullable: true
        reviewed_by:
          type: string
          nullable: true
        admin_notes:
          type: string
          nullable: true
        description:
          type: string
          nullable: true
          description: Extended description (optional, depends on ticket type)
        suggested_district:
          type: string
          nullable: true
        suggested_address:
          type: string
          nullable: true
        suggested_lat:
          type: number
          nullable: true
        suggested_lng:
          type: number
          nullable: true
        media_urls:
          type: array
          items:
            type: string
        created_organization_id:
          type: string
          format: uuid
          nullable: true

    TicketReview:
      type: object
      required:
        - action
      properties:
        action:
          type: string
          enum: [approve, reject]
        admin_notes:
          type: string
          description: Notes from the admin about the decision
        organization_id:
          type: string
          format: uuid
          description: Assign an existing organization on approval
        create_organization:
          type: boolean
          description: Create a new organization on approval

    TicketReviewResponse:
      type: object
      required: [message, ticket]
      properties:
        message:
          type: string
        ticket:
          $ref: '#/components/schemas/Ticket'
        organization:
          $ref: '#/components/schemas/Organization'
          nullable: true
          description: The organization created or assigned (only on approval)

    TicketListResponse:
      type: object
      required: [items, pending_count]
      properties:
        items:
          type: array
          items:
            $ref: '#/components/schemas/Ticket'
        next_cursor:
          type: string
          nullable: true
        pending_count:
          type: integer
          description: Number of pending tickets matching the current filters

    # Audit Log schemas
    AuditLogEntry:
      type: object
      required: [id, timestamp, table_name, record_id, action, source]
      properties:
        id:
          type: string
          format: uuid
        timestamp:
          type: string
          format: date-time
        table_name:
          type: string
        record_id:
          type: string
        action:
          type: string
          enum: [INSERT, UPDATE, DELETE]
        user_id:
          type: string
          nullable: true
        request_id:
          type: string
          nullable: true
        changed_fields:
          type: array
          items:
            type: string
          nullable: true
        old_values:
          type: object
          additionalProperties: true
          nullable: true
          description: Previous field values (sensitive fields redacted)
        new_values:
          type: object
          additionalProperties: true
          nullable: true
          description: New field values (sensitive fields redacted)
        source:
          type: string
          description: Source of the audit entry (trigger or application)
        ip_address:
          type: string
          nullable: true
          description: Client IP address if available
        user_agent:
          type: string
          nullable: true
          description: Client user agent if available

    AuditLogListResponse:
      type: object
      required: [items]
      properties:
        items:
          type: array
          items:
            $ref: '#/components/schemas/AuditLogEntry'
        next_cursor:
          type: string
          nullable: true

    # Geographic Area schemas
    GeographicArea:
      type: object
      required: [id, name, level, active, display_order]
      properties:
        id:
          type: string
          format: uuid
        parent_id:
          type: string
          format: uuid
          nullable: true
          description: NULL for root (country) nodes
        name:
          type: string
          description: Area name (e.g., 'Hong Kong', 'Wan Chai')
        level:
          type: string
          enum: [country, region, city, district]
        code:
          type: string
          nullable: true
          description: ISO 3166-1 alpha-2 for countries (HK, SG, AE)
        active:
          type: boolean
          description: Whether this area (and its children) is available
        display_order:
          type: integer
        children:
          type: array
          items:
            $ref: '#/components/schemas/GeographicArea'
          description: Nested child areas (populated in tree responses)

    AreaTreeResponse:
      type: object
      required: [items]
      properties:
        items:
          type: array
          items:
            $ref: '#/components/schemas/GeographicArea'

    # Organization Suggestion input schema (used by user-facing POST endpoint)
    OrganizationSuggestionCreate:
      type: object
      required:
        - organization_name
      properties:
        organization_name:
          type: string
          maxLength: 200
          description: Suggested organization name (required)
        description:
          type: string
          maxLength: 5000
          description: Organization description
        suggested_district:
          type: string
          maxLength: 100
          description: Suggested district
        suggested_address:
          type: string
          maxLength: 500
          description: Suggested address
        suggested_lat:
          type: number
          minimum: -90
          maximum: 90
          description: Latitude of the suggested location (-90 to 90)
        suggested_lng:
          type: number
          minimum: -180
          maximum: 180
          description: Longitude of the suggested location (-180 to 180)
        media_urls:
          type: array
          maxItems: 20
          items:
            type: string
            format: uri
            maxLength: 2048
          description: Optional media URLs for the suggestion
        additional_notes:
          type: string
          maxLength: 5000
          description: Additional notes for the admin

    # Health Check schemas
    HealthStatus:
      type: object
      required: [healthy]
      properties:
        healthy:
          type: boolean
        version:
          type: string
        environment:
          type: string
        checks:
          type: array
          items:
            $ref: '#/components/schemas/HealthCheckResult'

    HealthCheckResult:
      type: object
      required: [name, healthy]
      properties:
        name:
          type: string
        healthy:
          type: boolean
        latency_ms:
          type: number
          nullable: true
        error:
          type: string
          nullable: true
        details:
          type: object
          nullable: true
