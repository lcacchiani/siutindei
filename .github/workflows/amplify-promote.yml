name: Amplify Promote

on:
  workflow_dispatch:
    inputs:
      source_branch:
        description: "Amplify source branch (e.g., staging)"
        required: true
      target_branch:
        description: "Amplify target branch (e.g., main)"
        required: true

permissions:
  contents: read
  id-token: write

concurrency:
  group: amplify-promote
  cancel-in-progress: false

jobs:
  promote:
    runs-on: ubuntu-latest
    environment: production
    steps:
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v5
        with:
          role-to-assume: arn:aws:iam::${{ vars.AWS_ACCOUNT_ID }}:role/GitHubActionsRole
          aws-region: ${{ vars.AWS_REGION }}
          role-session-name: GitHubActions-${{ github.run_id }}

      - name: Validate inputs and app configuration
        run: |
          if [ -z "$AMPLIFY_APP_ID" ]; then
            echo "AMPLIFY_APP_ID variable is required"
            exit 1
          fi
          if [ -z "$SOURCE_BRANCH" ] || [ -z "$TARGET_BRANCH" ]; then
            echo "source_branch and target_branch are required"
            exit 1
          fi
          if [ "$SOURCE_BRANCH" != "staging" ] || [ "$TARGET_BRANCH" != "main" ]; then
            echo "Only staging -> main promotions are allowed"
            exit 1
          fi
        env:
          AMPLIFY_APP_ID: ${{ vars.AMPLIFY_APP_ID }}
          SOURCE_BRANCH: ${{ inputs.source_branch }}
          TARGET_BRANCH: ${{ inputs.target_branch }}

      - name: Ensure source branch build is green
        run: |
          status=$(aws amplify list-jobs \
            --app-id "$AMPLIFY_APP_ID" \
            --branch-name "$SOURCE_BRANCH" \
            --max-items 1 \
            --query "jobSummaries[0].status" \
            --output text)
          echo "Latest job status on $SOURCE_BRANCH: $status"
          if [ "$status" != "SUCCEED" ]; then
            echo "Source branch build is not green"
            exit 1
          fi
        env:
          AMPLIFY_APP_ID: ${{ vars.AMPLIFY_APP_ID }}
          SOURCE_BRANCH: ${{ inputs.source_branch }}

      - name: Promote to target branch
        run: |
          aws amplify start-job \
            --app-id "$AMPLIFY_APP_ID" \
            --branch-name "$TARGET_BRANCH" \
            --job-type RELEASE
        env:
          AMPLIFY_APP_ID: ${{ vars.AMPLIFY_APP_ID }}
          TARGET_BRANCH: ${{ inputs.target_branch }}
