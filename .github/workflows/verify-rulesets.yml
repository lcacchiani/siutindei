name: Verify GitHub Rulesets

on:
  schedule:
    # Run weekly on Monday at 9am UTC
    - cron: "0 9 * * 1"
  workflow_dispatch:

permissions:
  contents: read

jobs:
  verify-branch-protection:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Verify main branch protection
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          echo "Checking branch protection for 'main'..."

          # Get repository info
          REPO="${{ github.repository }}"

          # Check if branch protection exists (via rulesets or legacy protection)
          echo "Fetching rulesets..."
          RULESETS=$(gh api "repos/${REPO}/rulesets" --jq '.[] | select(.target == "branch") | .name' 2>/dev/null || echo "")

          if [ -n "$RULESETS" ]; then
            echo "✅ Branch rulesets found:"
            echo "$RULESETS"
          else
            echo "⚠️  No branch rulesets found. Checking legacy branch protection..."
          fi

          # Check legacy branch protection rules
          PROTECTION=$(gh api "repos/${REPO}/branches/main/protection" 2>/dev/null || echo "NOT_FOUND")

          if [ "$PROTECTION" = "NOT_FOUND" ]; then
            if [ -z "$RULESETS" ]; then
              echo "❌ ERROR: No branch protection configured for 'main'"
              echo ""
              echo "Please configure branch protection. See docs/architecture/github-rulesets.md"
              exit 1
            fi
          else
            echo "✅ Legacy branch protection is configured for 'main'"

            # Verify specific settings
            echo ""
            echo "Checking protection settings..."

            # Check required reviews
            REQUIRED_REVIEWS=$(echo "$PROTECTION" | gh api --input - --jq '.required_pull_request_reviews.required_approving_review_count // 0' 2>/dev/null || echo "0")
            if [ "$REQUIRED_REVIEWS" -ge 1 ]; then
              echo "✅ Required approving reviews: $REQUIRED_REVIEWS"
            else
              echo "⚠️  WARNING: No required approving reviews configured"
            fi

            # Check required status checks
            STATUS_CHECKS=$(gh api "repos/${REPO}/branches/main/protection/required_status_checks" --jq '.contexts[]' 2>/dev/null || echo "")
            if [ -n "$STATUS_CHECKS" ]; then
              echo "✅ Required status checks:"
              echo "$STATUS_CHECKS" | sed 's/^/   - /'

              # Verify lint and test are required
              if echo "$STATUS_CHECKS" | grep -q "lint"; then
                echo "✅ 'lint' check is required"
              else
                echo "⚠️  WARNING: 'lint' check is not required"
              fi

              if echo "$STATUS_CHECKS" | grep -q "test"; then
                echo "✅ 'test' check is required"
              else
                echo "⚠️  WARNING: 'test' check is not required"
              fi
            else
              echo "⚠️  WARNING: No required status checks configured"
            fi

            # Check enforce admins
            ENFORCE_ADMINS=$(gh api "repos/${REPO}/branches/main/protection/enforce_admins" --jq '.enabled' 2>/dev/null || echo "false")
            if [ "$ENFORCE_ADMINS" = "true" ]; then
              echo "✅ Admin enforcement is enabled"
            else
              echo "ℹ️  Admin enforcement is disabled (admins can bypass)"
            fi
          fi

          echo ""
          echo "Branch protection verification complete."

      - name: Verify tag protection
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          echo "Checking tag protection..."

          REPO="${{ github.repository }}"

          # Check for tag rulesets
          TAG_RULESETS=$(gh api "repos/${REPO}/rulesets" --jq '.[] | select(.target == "tag") | .name' 2>/dev/null || echo "")

          if [ -n "$TAG_RULESETS" ]; then
            echo "✅ Tag rulesets found:"
            echo "$TAG_RULESETS"
          else
            # Check legacy tag protection
            TAG_PROTECTION=$(gh api "repos/${REPO}/tags/protection" 2>/dev/null || echo "NOT_FOUND")

            if [ "$TAG_PROTECTION" = "NOT_FOUND" ] || [ "$TAG_PROTECTION" = "[]" ]; then
              echo "⚠️  WARNING: No tag protection configured"
              echo "   Consider protecting 'v*' tags. See docs/architecture/github-rulesets.md"
            else
              echo "✅ Legacy tag protection is configured"
            fi
          fi

          echo ""
          echo "Tag protection verification complete."

      - name: Summary
        run: |
          echo ""
          echo "========================================"
          echo "GitHub Rulesets Verification Complete"
          echo "========================================"
          echo ""
          echo "For setup instructions, see:"
          echo "  docs/architecture/github-rulesets.md"
          echo ""
          echo "To configure via GitHub UI:"
          echo "  Settings → Rules → Rulesets"
