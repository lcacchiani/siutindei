name: Deploy iOS

on:
  workflow_dispatch:

permissions:
  contents: read

concurrency:
  group: deploy-ios
  cancel-in-progress: false

jobs:
  build-and-deploy:
    runs-on: macos-latest
    environment: production
    env:
      MATCH_DEPLOY_KEY: ${{ secrets.MATCH_DEPLOY_KEY }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: "stable"
          cache: true

      - name: Install CocoaPods
        run: sudo gem install cocoapods

      - name: Install Fastlane
        run: sudo gem install fastlane

      - name: Install dependencies
        run: flutter pub get
        working-directory: apps/siutindei_app

      - name: Setup SSH for certificates repo
        uses: webfactory/ssh-agent@v0.9.1
        if: ${{ env.MATCH_DEPLOY_KEY != '' }}
        with:
          ssh-private-key: ${{ env.MATCH_DEPLOY_KEY }}

      - name: Sync signing assets (match)
        working-directory: apps/siutindei_app/ios
        run: |
          if [ -z "$MATCH_GIT_URL" ] || [ -z "$MATCH_PASSWORD" ] || [ -z "$FASTLANE_USER" ] || [ -z "$FASTLANE_APPLE_APPLICATION_SPECIFIC_PASSWORD" ]; then
            echo "Skipping fastlane match (missing secrets)"
            exit 0
          fi
          fastlane match appstore --readonly
        env:
          MATCH_GIT_URL: ${{ secrets.MATCH_GIT_URL }}
          MATCH_PASSWORD: ${{ secrets.MATCH_PASSWORD }}
          FASTLANE_USER: ${{ secrets.FASTLANE_USER }}
          FASTLANE_APPLE_APPLICATION_SPECIFIC_PASSWORD: ${{ secrets.FASTLANE_APPLE_APPLICATION_SPECIFIC_PASSWORD }}
          MATCH_APP_IDENTIFIER: ${{ vars.IOS_BUNDLE_ID }}
          MATCH_TEAM_ID: ${{ vars.APPLE_TEAM_ID }}
          FASTLANE_TEAM_ID: ${{ vars.APPLE_TEAM_ID }}

      - name: Generate ExportOptions.plist
        run: |
          python3 - <<'PY'
          import os
          import plistlib
          from pathlib import Path

          team_id = os.environ.get("APPLE_TEAM_ID")
          bundle_id = os.environ.get("IOS_BUNDLE_ID")
          profile_name = os.environ.get("IOS_PROVISIONING_PROFILE", "").strip()

          if not team_id or not bundle_id:
              raise SystemExit("APPLE_TEAM_ID and IOS_BUNDLE_ID are required")

          data = {
              "method": "app-store",
              "teamID": team_id,
              "compileBitcode": False,
              "stripSwiftSymbols": True,
              "uploadSymbols": True,
              "uploadBitcode": False,
              "thinning": "<none>",
              "signingCertificate": "Apple Distribution",
          }

          if profile_name:
              data["signingStyle"] = "manual"
              data["provisioningProfiles"] = {bundle_id: profile_name}
          else:
              data["signingStyle"] = "automatic"

          output_path = Path("apps/siutindei_app/ios/ExportOptions.plist")
          output_path.write_bytes(plistlib.dumps(data))
          PY
        env:
          APPLE_TEAM_ID: ${{ vars.APPLE_TEAM_ID }}
          IOS_BUNDLE_ID: ${{ vars.IOS_BUNDLE_ID }}
          IOS_PROVISIONING_PROFILE: ${{ vars.IOS_PROVISIONING_PROFILE }}

      - name: Build release IPA
        run: |
          flutter build ipa --release --export-options-plist=ios/ExportOptions.plist \
            --dart-define=AMPLIFY_API_KEY=${{ secrets.AMPLIFY_API_KEY }} \
            --dart-define=FIREBASE_API_KEY=${{ vars.FIREBASE_API_KEY }} \
            --dart-define=FIREBASE_PROJECT_ID=${{ vars.FIREBASE_PROJECT_ID }} \
            --dart-define=FIREBASE_MESSAGING_SENDER_ID=${{ vars.FIREBASE_MESSAGING_SENDER_ID }} \
            --dart-define=FIREBASE_IOS_APP_ID=${{ vars.FIREBASE_IOS_APP_ID }} \
            --dart-define=FIREBASE_IOS_BUNDLE_ID=${{ vars.IOS_BUNDLE_ID }} \
            --dart-define=FIREBASE_STORAGE_BUCKET=${{ vars.FIREBASE_STORAGE_BUCKET }} \
            --dart-define=FIREBASE_APP_CHECK_DEBUG=${{ vars.FIREBASE_APP_CHECK_DEBUG }}
        working-directory: apps/siutindei_app

      - name: Load App Store Connect API key
        run: |
          if [ -z "$APPSTORE_API_KEY_JSON" ] && { [ -z "$APPSTORE_ISSUER_ID" ] || [ -z "$APPSTORE_API_KEY_ID" ] || [ -z "$APPSTORE_API_PRIVATE_KEY" ]; }; then
            echo "Skipping App Store Connect API key setup (missing secrets)"
            exit 0
          fi
          python - <<'PY'
          import json
          import os

          payload = os.environ.get("APPSTORE_API_KEY_JSON")
          if payload:
            data = json.loads(payload)
            issuer_id = data.get("issuer_id")
            key_id = data.get("key_id")
            private_key = data.get("private_key")
          else:
            issuer_id = os.environ.get("APPSTORE_ISSUER_ID")
            key_id = os.environ.get("APPSTORE_API_KEY_ID")
            private_key = os.environ.get("APPSTORE_API_PRIVATE_KEY")

          if not issuer_id or not key_id or not private_key:
            raise SystemExit("Missing App Store Connect API key inputs")

          env_path = os.environ["GITHUB_ENV"]
          with open(env_path, "a") as f:
            f.write(f"APPSTORE_ISSUER_ID={issuer_id}\n")
            f.write(f"APPSTORE_API_KEY_ID={key_id}\n")
            f.write("APPSTORE_API_PRIVATE_KEY<<EOF\n")
            f.write(private_key.strip() + "\n")
            f.write("EOF\n")
          PY
        env:
          APPSTORE_API_KEY_JSON: ${{ secrets.APPSTORE_API_KEY_JSON }}
          APPSTORE_ISSUER_ID: ${{ secrets.APPSTORE_ISSUER_ID }}
          APPSTORE_API_KEY_ID: ${{ secrets.APPSTORE_API_KEY_ID }}
          APPSTORE_API_PRIVATE_KEY: ${{ secrets.APPSTORE_API_PRIVATE_KEY }}

      - name: Upload to TestFlight
        if: env.APPSTORE_ISSUER_ID != '' && env.APPSTORE_API_KEY_ID != '' && env.APPSTORE_API_PRIVATE_KEY != ''
        uses: apple-actions/upload-testflight-build@v4
        with:
          app-path: apps/siutindei_app/build/ios/ipa/*.ipa
          issuer-id: ${{ env.APPSTORE_ISSUER_ID }}
          api-key-id: ${{ env.APPSTORE_API_KEY_ID }}
          api-private-key: ${{ env.APPSTORE_API_PRIVATE_KEY }}
