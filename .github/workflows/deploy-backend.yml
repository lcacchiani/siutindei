name: Deploy Backend

on:
  workflow_dispatch:
  push:
    branches:
      - main
    paths:
      - "backend/**"
      - "packages/models_shared/**"
      - "scripts/**"

permissions:
  contents: read
  id-token: write

concurrency:
  group: deploy-backend
  cancel-in-progress: false

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: production
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "lts/*"
          cache: "npm"
          cache-dependency-path: backend/infrastructure/package-lock.json

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::${{ vars.AWS_ACCOUNT_ID }}:role/GitHubActionsRole
          aws-region: ${{ vars.AWS_REGION }}
          role-session-name: GitHubActions-${{ github.run_id }}

      - name: Deploy backend with CDK
        run: |
          if [ -f "backend/infrastructure/package.json" ]; then
            cd backend/infrastructure
            npm ci
            npm run build --if-present
            PARAM_ARGS=()
            PARAM_FILE="${CDK_PARAM_FILE:-}"
            if [ -n "$PARAM_FILE" ] && [ -f "$PARAM_FILE" ]; then
              readarray -t PARAM_ARGS < <(python3 - <<'PY'
import json
import os

path = os.environ["PARAM_FILE"]
with open(path, "r", encoding="utf-8") as handle:
    params = json.load(handle)

for key, value in params.items():
    if value is None:
        continue
    value_str = str(value).strip()
    if not value_str:
        continue
    print("--parameters")
    print(f"{key}={value_str}")
PY
              )
            fi
            if [ -n "$CDK_STACKS" ]; then
              npx cdk deploy --require-approval never $CDK_STACKS "${PARAM_ARGS[@]}"
            else
              npx cdk deploy --require-approval never "${PARAM_ARGS[@]}"
            fi
          else
            echo "Missing backend/infrastructure/package.json"
          fi
        env:
          CDK_STACKS: ${{ vars.CDK_STACKS }}
          CDK_PARAM_FILE: ${{ vars.CDK_PARAM_FILE }}
