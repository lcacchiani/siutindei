name: Deploy Backend

on:
  workflow_dispatch:
  push:
    branches:
      - main
    paths:
      - "backend/**"
      - "packages/models_shared/**"
      - "scripts/**"

permissions:
  contents: read
  id-token: write

concurrency:
  group: deploy-backend
  cancel-in-progress: false

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: production
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "lts/*"
          cache: "npm"
          cache-dependency-path: backend/infrastructure/package-lock.json

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::${{ vars.AWS_ACCOUNT_ID }}:role/GitHubActionsRole
          aws-region: ${{ vars.AWS_REGION }}
          role-session-name: GitHubActions-${{ github.run_id }}

      - name: Deploy backend with CDK
        run: |
          if [ -f "backend/infrastructure/package.json" ]; then
            cd backend/infrastructure
            npm ci
            npm run build --if-present
            if [ -n "$CDK_STACKS" ]; then
              npx cdk deploy --require-approval never $CDK_STACKS
            else
              npx cdk deploy --require-approval never
            fi
          else
            echo "Missing backend/infrastructure/package.json"
          fi
        env:
          CDK_STACKS: ${{ vars.CDK_STACKS }}
