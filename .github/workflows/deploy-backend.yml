name: Deploy Backend

on:
  workflow_dispatch:
    inputs:
      destroy_before_deploy:
        description: "Run 'cdk destroy' before deploy"
        required: false
        default: false
        type: boolean
  push:
    branches:
      - main
    paths:
      - "backend/**"
      - "packages/models_shared/**"
      - "scripts/**"

permissions:
  contents: read
  id-token: write

concurrency:
  group: deploy-backend
  cancel-in-progress: false

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: production
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Set up Node.js
        uses: actions/setup-node@v6
        with:
          node-version: "lts/*"
          cache: "npm"
          cache-dependency-path: backend/infrastructure/package-lock.json

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v5
        with:
          role-to-assume: arn:aws:iam::${{ vars.AWS_ACCOUNT_ID }}:role/GitHubActionsRole
          aws-region: ${{ vars.AWS_REGION }}
          role-session-name: GitHubActions-${{ github.run_id }}

      - name: Install backend dependencies
        run: |
          if [ -f "backend/infrastructure/package.json" ]; then
            cd backend/infrastructure
            npm ci
          else
            echo "Missing backend/infrastructure/package.json"
          fi

      - name: Bootstrap CDK
        run: |
          if [ -f "backend/infrastructure/package.json" ]; then
            cd backend/infrastructure
            npx cdk acknowledge 34892 || true
            if [ -n "$CDK_BOOTSTRAP_QUALIFIER" ]; then
              npx cdk bootstrap --no-notices --qualifier "$CDK_BOOTSTRAP_QUALIFIER" "aws://$AWS_ACCOUNT_ID/$AWS_REGION"
            else
              npx cdk bootstrap --no-notices "aws://$AWS_ACCOUNT_ID/$AWS_REGION"
            fi
          else
            echo "Missing backend/infrastructure/package.json"
          fi
        env:
          AWS_ACCOUNT_ID: ${{ vars.AWS_ACCOUNT_ID }}
          AWS_REGION: ${{ vars.AWS_REGION }}
          CDK_BOOTSTRAP_QUALIFIER: ${{ vars.CDK_BOOTSTRAP_QUALIFIER }}

      - name: Build CDK secret parameters file
        run: |
          python3 - <<'PY'
          import json
          import os
          from pathlib import Path

          mapping = {
              "GoogleClientSecret": os.getenv("CDK_PARAM_GOOGLE_CLIENT_SECRET", ""),
              "ApplePrivateKey": os.getenv("CDK_PARAM_APPLE_PRIVATE_KEY", ""),
              "MicrosoftClientSecret": os.getenv("CDK_PARAM_MICROSOFT_CLIENT_SECRET", ""),
              "PublicApiKeyValue": os.getenv("CDK_PARAM_PUBLIC_API_KEY_VALUE", ""),
              "AdminBootstrapTempPassword": os.getenv(
                  "CDK_PARAM_ADMIN_BOOTSTRAP_TEMP_PASSWORD", ""
              ),
          }
          params = {k: v for k, v in mapping.items() if v}
          if not params:
              raise SystemExit(0)

          output_path = Path("/tmp/cdk-secret-params.json")
          output_path.write_text(json.dumps(params), encoding="utf-8")
          env_path = os.environ["GITHUB_ENV"]
          with open(env_path, "a", encoding="utf-8") as handle:
              handle.write(f"CDK_SECRET_PARAM_FILE={output_path}\n")
          PY
        env:
          CDK_PARAM_GOOGLE_CLIENT_SECRET: ${{ secrets.CDK_PARAM_GOOGLE_CLIENT_SECRET }}
          CDK_PARAM_APPLE_PRIVATE_KEY: ${{ secrets.CDK_PARAM_APPLE_PRIVATE_KEY }}
          CDK_PARAM_MICROSOFT_CLIENT_SECRET: ${{ secrets.CDK_PARAM_MICROSOFT_CLIENT_SECRET }}
          CDK_PARAM_PUBLIC_API_KEY_VALUE: ${{ secrets.CDK_PARAM_PUBLIC_API_KEY_VALUE }}
          CDK_PARAM_ADMIN_BOOTSTRAP_TEMP_PASSWORD: ${{ secrets.CDK_PARAM_ADMIN_BOOTSTRAP_TEMP_PASSWORD }}

      - name: Build CDK non-secret parameters file
        run: |
          python3 - <<'PY'
          import os
          import json
          from pathlib import Path

          project_number = os.getenv("FIREBASE_MESSAGING_SENDER_ID", "").strip()
          android_app_id = os.getenv("FIREBASE_ANDROID_APP_ID", "").strip()
          ios_app_id = os.getenv("FIREBASE_IOS_APP_ID", "").strip()
          apple_team_id = os.getenv("APPLE_TEAM_ID", "").strip()

          params = {}

          if apple_team_id:
              params["AppleTeamId"] = apple_team_id

          if project_number and android_app_id and ios_app_id:
              audience = (
                  f"projects/{project_number}/apps/{ios_app_id},"
                  f"projects/{project_number}/apps/{android_app_id}"
              )
              params["DeviceAttestationAudience"] = audience

          if not params:
              raise SystemExit(0)
          output_path = Path("/tmp/cdk-non-secret-params.json")
          output_path.write_text(json.dumps(params), encoding="utf-8")
          env_path = os.environ["GITHUB_ENV"]
          with open(env_path, "a", encoding="utf-8") as handle:
              handle.write(f"CDK_NON_SECRET_PARAM_FILE={output_path}\n")
          PY
        env:
          APPLE_TEAM_ID: ${{ vars.APPLE_TEAM_ID }}
          FIREBASE_MESSAGING_SENDER_ID: ${{ vars.FIREBASE_MESSAGING_SENDER_ID }}
          FIREBASE_ANDROID_APP_ID: ${{ vars.FIREBASE_ANDROID_APP_ID }}
          FIREBASE_IOS_APP_ID: ${{ vars.FIREBASE_IOS_APP_ID }}

      - name: Detect existing database resources
        run: |
          set -e
          resource_prefix="lxsoftware-siutindei"
          vpc_name="${resource_prefix}-vpc"
          db_sg_name="${resource_prefix}-db-sg"
          proxy_sg_name="${resource_prefix}-proxy-sg"
          secret_name="${resource_prefix}-database-credentials"

          if aws secretsmanager describe-secret --secret-id "$secret_name" \
            >/dev/null 2>&1; then
            echo "EXISTING_DB_CREDENTIALS_SECRET_NAME=$secret_name" \
              >> "$GITHUB_ENV"
          fi

          vpc_id=$(aws ec2 describe-vpcs \
            --filters "Name=tag:Name,Values=$vpc_name" \
            --query "Vpcs[0].VpcId" \
            --output text 2>/dev/null || true)

          if [ -n "$vpc_id" ] && [ "$vpc_id" != "None" ]; then
            db_sg_id=$(aws ec2 describe-security-groups \
              --filters "Name=vpc-id,Values=$vpc_id" \
                "Name=group-name,Values=$db_sg_name" \
              --query "SecurityGroups[0].GroupId" \
              --output text 2>/dev/null || true)
            if [ -n "$db_sg_id" ] && [ "$db_sg_id" != "None" ]; then
              echo "EXISTING_DB_SECURITY_GROUP_ID=$db_sg_id" \
                >> "$GITHUB_ENV"
            fi

            proxy_sg_id=$(aws ec2 describe-security-groups \
              --filters "Name=vpc-id,Values=$vpc_id" \
                "Name=group-name,Values=$proxy_sg_name" \
              --query "SecurityGroups[0].GroupId" \
              --output text 2>/dev/null || true)
            if [ -n "$proxy_sg_id" ] && [ "$proxy_sg_id" != "None" ]; then
              echo "EXISTING_PROXY_SECURITY_GROUP_ID=$proxy_sg_id" \
                >> "$GITHUB_ENV"
            fi
          fi

      - name: Deploy backend with CDK
        run: |
          if [ -f "backend/infrastructure/package.json" ]; then
            cd backend/infrastructure
            npx cdk acknowledge 34892 || true
            npm run build --if-present
            PARAM_ARGS=()
            PARAM_FILES=()
            resolve_param_file() {
              local path="$1"
              if [ -z "$path" ]; then
                return 1
              fi
              if [ -f "$path" ]; then
                echo "$path"
                return 0
              fi
              if [ -n "$GITHUB_WORKSPACE" ] && [ -f "$GITHUB_WORKSPACE/$path" ]; then
                echo "$GITHUB_WORKSPACE/$path"
                return 0
              fi
              return 1
            }
            if [ -n "${CDK_PARAM_FILE:-}" ]; then
              RESOLVED_PARAM_FILE=$(resolve_param_file "$CDK_PARAM_FILE" || true)
              if [ -n "$RESOLVED_PARAM_FILE" ]; then
                PARAM_FILES+=("$RESOLVED_PARAM_FILE")
              else
                echo "CDK_PARAM_FILE '$CDK_PARAM_FILE' not found"
                exit 1
              fi
            fi
            if [ -n "${CDK_SECRET_PARAM_FILE:-}" ] && [ -f "$CDK_SECRET_PARAM_FILE" ]; then
              PARAM_FILES+=("$CDK_SECRET_PARAM_FILE")
            fi
            if [ -n "${CDK_NON_SECRET_PARAM_FILE:-}" ] && [ -f "$CDK_NON_SECRET_PARAM_FILE" ]; then
              PARAM_FILES+=("$CDK_NON_SECRET_PARAM_FILE")
            fi
            if [ ${#PARAM_FILES[@]} -gt 0 ]; then
              PARAM_FILES_CSV=$(IFS=, ; echo "${PARAM_FILES[*]}")
              PARAM_ARGS_FILE="$(mktemp)"
              PARAM_FILES="$PARAM_FILES_CSV" python3 - <<'PY' > "$PARAM_ARGS_FILE"
          import json
          import os

          paths = [p for p in os.environ.get("PARAM_FILES", "").split(",") if p]
          params = {}
          for path in paths:
              with open(path, "r", encoding="utf-8") as handle:
                  params.update(json.load(handle))

          for key, value in params.items():
              if value is None:
                  continue
              value_str = str(value)
              value_str = value_str.replace("\r\n", "\n").replace("\r", "\n")
              value_str = value_str.replace("\n", "\\n").strip()
              if not value_str:
                  continue
              print("--parameters")
              print(f"{key}={value_str}")
          PY
              readarray -t PARAM_ARGS < "$PARAM_ARGS_FILE"
            fi
            QUALIFIER_ARGS=()
            if [ -n "$CDK_BOOTSTRAP_QUALIFIER" ]; then
              QUALIFIER_ARGS=(--qualifier "$CDK_BOOTSTRAP_QUALIFIER")
            fi
            STACK_ARGS=()
            if [ -n "${CDK_STACKS:-}" ]; then
              IFS=$', \n\t' read -r -a STACK_LIST <<< "$CDK_STACKS"
              for stack in "${STACK_LIST[@]}"; do
                trimmed="${stack#"${stack%%[![:space:]]*}"}"
                trimmed="${trimmed%"${trimmed##*[![:space:]]}"}"
                if [ -n "$trimmed" ]; then
                  STACK_ARGS+=("$trimmed")
                fi
              done
            fi
            if [ "${DESTROY_BEFORE_DEPLOY:-false}" = "true" ]; then
              if [ ${#STACK_ARGS[@]} -gt 0 ]; then
                npx cdk destroy --no-notices --force "${QUALIFIER_ARGS[@]}" "${STACK_ARGS[@]}"
              else
                npx cdk destroy --no-notices --force "${QUALIFIER_ARGS[@]}" ActivitiesApiStack
              fi
            fi
            if [ ${#STACK_ARGS[@]} -gt 0 ]; then
              npx cdk deploy --no-notices --require-approval never "${QUALIFIER_ARGS[@]}" "${PARAM_ARGS[@]}" "${STACK_ARGS[@]}"
            else
              npx cdk deploy --no-notices --require-approval never "${QUALIFIER_ARGS[@]}" "${PARAM_ARGS[@]}"
            fi
          else
            echo "Missing backend/infrastructure/package.json"
          fi
        env:
          CDK_STACKS: ${{ vars.CDK_STACKS }}
          CDK_PARAM_FILE: ${{ vars.CDK_PARAM_FILE }}
          CDK_SECRET_PARAM_FILE: ${{ env.CDK_SECRET_PARAM_FILE }}
          CDK_NON_SECRET_PARAM_FILE: ${{ env.CDK_NON_SECRET_PARAM_FILE }}
          CDK_BOOTSTRAP_QUALIFIER: ${{ vars.CDK_BOOTSTRAP_QUALIFIER }}
          DESTROY_BEFORE_DEPLOY: ${{ github.event.inputs.destroy_before_deploy || 'false' }}
          EXISTING_DB_CREDENTIALS_SECRET_NAME: ${{ env.EXISTING_DB_CREDENTIALS_SECRET_NAME }}
          EXISTING_DB_SECURITY_GROUP_ID: ${{ env.EXISTING_DB_SECURITY_GROUP_ID }}
          EXISTING_PROXY_SECURITY_GROUP_ID: ${{ env.EXISTING_PROXY_SECURITY_GROUP_ID }}
